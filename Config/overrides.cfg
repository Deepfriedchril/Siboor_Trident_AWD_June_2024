################################################################################
##                              Homing Override
################################################################################
[homing_override]
axes: xyz
gcode:
    SAVE_GCODE_STATE NAME=PRE_HOMING_STATE

    {% set HA = printer.toolhead.homed_axes %}
    {% set pos = printer.toolhead.position %}

    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
    {% set home_Y = home_all or 'Y' in params or ('X' in params and 'y' not in HA) %}
    {% set home_X = home_all or 'X' in params %}

    {% if 'Z' not in HA or pos.z < 2 %}
        # Move down the build plate for safety.
        G91
        G0 Z10 F1200
        G90
    {% endif %}

    {% if home_Y or ('y' not in HA and 'Z' in params)%}
        G28 Y
    {% endif %}

    {% if home_X or ('x' not in HA and 'Z' in params) %}
        G28 X
    {% endif %}

    {% if home_all or 'Z' in params %}
        G1 X150 Y150 F36000
        G28 Z
    {% endif %}

    RESTORE_GCODE_STATE NAME=PRE_HOMING_STATE


################################################################################
##                                  Z Tilt
################################################################################
[z_tilt]
z_positions:
  -50, 18
  150, 348
  350, 18
points:
  50, 50
  150, 250
  250, 50

speed: 600                 # Speed of Z tilt adjustment
horizontal_move_z: 2       # Z axis move speed for adjustments
retries: 10                # Number of retries for adjustment points
retry_tolerance: 0.0075    # Retry tolerance for adjustment accuracy

#-------------------------------------------------------------------------------
[gcode_macro Z_TILT_ADJUST]     # IDM/Cartographer optimized 3Z leveling macro
rename_existing: _Z_TILT_ADJUST
gcode:
    SAVE_GCODE_STATE NAME=STATE_Z_TILT         # Save current state for Z tilt adjustment
    BED_MESH_CLEAR                             # Clear bed mesh
    {% if not printer.z_tilt.applied %}
      _Z_TILT_ADJUST horizontal_move_z=10 retry_tolerance=1   # Adjust Z tilt with higher tolerance initially
    {% endif %}
    _Z_TILT_ADJUST horizontal_move_z=2          # Fine-tune Z tilt adjustment
    RESTORE_GCODE_STATE NAME=STATE_Z_TILT       # Restore saved state after adjustment
    CENTER


################################################################################
##                  Bed Leveling and Height Calibration Macro
################################################################################
[gcode_macro G32]
gcode:
    BED_MESH_CLEAR               # Clear bed mesh
    G28                          # Home all axes
    Z_TILT_ADJUST                # Perform gantry leveling
    G28 Z                        # Home Z axes again
    G0 X150 Y150 Z30 F3600       # Fast move to X150 Y150 Z30 at 3600 mm/min
